# Workflow åç§°ï¼šæ£€æŸ¥ PR ç›®æ ‡åˆ†æ”¯å’Œ Rust ä»£ç è´¨é‡
# æ­¤ workflow ä¼šåœ¨ Pull Request åˆ›å»ºã€æ›´æ–°æˆ–é‡æ–°æ‰“å¼€æ—¶è‡ªåŠ¨è¿è¡Œ
name: Check PR target branch

# å®šä¹‰è§¦å‘æ¡ä»¶ï¼šå½“ PR è¢«åˆ›å»ºã€åŒæ­¥ï¼ˆæœ‰æ–°æäº¤ï¼‰æˆ–é‡æ–°æ‰“å¼€æ—¶è§¦å‘
on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Job 1: æ£€æŸ¥ PR çš„ç›®æ ‡åˆ†æ”¯æ˜¯å¦ä¸º main
  # ç¡®ä¿æ‰€æœ‰ PR éƒ½æŒ‡å‘ä¸»åˆ†æ”¯ï¼Œé¿å…è¯¯æ“ä½œ
  check-main:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: éªŒè¯ PR çš„ç›®æ ‡åˆ†æ”¯
      # è·å– PR çš„åŸºç¡€åˆ†æ”¯ï¼ˆtarget branchï¼‰ï¼Œå¦‚æœä¸æ˜¯ main åˆ™æŠ¥é”™å¹¶é€€å‡º
      - name: Verify PR target branch
        run: |
          echo "Target branch: ${{ github.event.pull_request.base.ref }}"
          if [ "${{ github.event.pull_request.base.ref }}" != "main" ]; then
            echo "Error: Pull requests must target the 'main' branch."
            exit 1
          fi

  # Job 2: æ£€æŸ¥ Rust ä»£ç è´¨é‡
  # å¹¶è¡Œè¿è¡Œï¼Œä¸ä¾èµ– check-main job çš„ç»“æœ
  # åŒ…æ‹¬ä»£ç æ ¼å¼ã€ç¼–è¯‘æ£€æŸ¥å’Œä»£ç è´¨é‡æ£€æŸ¥
  check-rust:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç åˆ° runner
      # ä½¿ç”¨å®˜æ–¹ checkout actionï¼Œå°†ä»“åº“ä»£ç ä¸‹è½½åˆ°å·¥ä½œç›®å½•
      - name: Checkout code
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: è®¾ç½® Rust å·¥å…·é“¾
      # å®‰è£…ç¨³å®šç‰ˆçš„ Rust ç¼–è¯‘å™¨ï¼Œå¹¶å®‰è£… rustfmtï¼ˆä»£ç æ ¼å¼åŒ–å·¥å…·ï¼‰å’Œ clippyï¼ˆä»£ç æ£€æŸ¥å·¥å…·ï¼‰
      # è¿™äº›å·¥å…·ç”¨äºåç»­çš„ä»£ç æ ¼å¼æ£€æŸ¥å’Œä»£ç è´¨é‡æ£€æŸ¥
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      # æ­¥éª¤ 3: ç¼“å­˜ Cargo ä¾èµ–å’Œç¼–è¯‘äº§ç‰©
      # ç¼“å­˜ Cargo çš„æ³¨å†Œè¡¨ã€ä¾èµ–åŒ…å’Œç¼–è¯‘ç›®æ ‡ç›®å½•ï¼Œä»¥åŠ é€Ÿåç»­æ„å»º
      # key åŸºäºæ“ä½œç³»ç»Ÿå’Œ Cargo.lock çš„å“ˆå¸Œå€¼ï¼Œå½“ä¾èµ–å˜åŒ–æ—¶ç¼“å­˜ä¼šå¤±æ•ˆ
      # restore-keys ç”¨äºéƒ¨åˆ†åŒ¹é…ï¼Œå³ä½¿ key ä¸å®Œå…¨åŒ¹é…ä¹Ÿèƒ½æ¢å¤éƒ¨åˆ†ç¼“å­˜
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/              # Cargo äºŒè¿›åˆ¶æ–‡ä»¶
            ~/.cargo/registry/index/   # Cargo æ³¨å†Œè¡¨ç´¢å¼•
            ~/.cargo/registry/cache/   # ä¸‹è½½çš„ä¾èµ–åŒ…ç¼“å­˜
            ~/.cargo/git/db/           # Git ä¾èµ–çš„æ•°æ®åº“
            src-tauri/target/          # Rust ç¼–è¯‘äº§ç‰©ç›®å½•
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      # æ­¥éª¤ 4: æ£€æŸ¥ Rust ä»£ç æ ¼å¼
      # ä½¿ç”¨ cargo fmt --check æ£€æŸ¥ä»£ç æ˜¯å¦ç¬¦åˆ Rust æ ‡å‡†æ ¼å¼
      # continue-on-error: true è¡¨ç¤ºå³ä½¿æ­¤æ­¥éª¤å¤±è´¥ï¼Œåç»­æ­¥éª¤ä»ä¼šç»§ç»­æ‰§è¡Œ
      # è¿™æ ·å¯ä»¥æ”¶é›†æ‰€æœ‰æ£€æŸ¥çš„é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é‡åˆ°ç¬¬ä¸€ä¸ªé”™è¯¯å°±åœæ­¢
      - name: Check Rust code formatting
        id: fmt-check  # ç»™æ­¥éª¤è®¾ç½® IDï¼Œåç»­å¯ä»¥é€šè¿‡ steps.fmt-check.outcome å¼•ç”¨æ­¤æ­¥éª¤çš„ç»“æœ
        working-directory: src-tauri  # åœ¨ src-tauri ç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤
        continue-on-error: true  # å³ä½¿å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤
        run: |
          # å°†æ£€æŸ¥æ ‡é¢˜å†™å…¥ GitHub Actions Summaryï¼ˆå¯åœ¨ Actions é¡µé¢æŸ¥çœ‹ï¼‰
          echo "## ğŸ” Code Formatting Check" >> $GITHUB_STEP_SUMMARY
          # è¿è¡Œ cargo fmt --check æ£€æŸ¥æ ¼å¼
          # --check è¡¨ç¤ºåªæ£€æŸ¥ä¸ä¿®æ”¹ï¼Œ--color=always ä¿æŒé¢œè‰²è¾“å‡º
          # 2>&1 å°†æ ‡å‡†é”™è¯¯é‡å®šå‘åˆ°æ ‡å‡†è¾“å‡ºï¼Œtee åŒæ—¶è¾“å‡ºåˆ°ç»ˆç«¯å’Œæ–‡ä»¶
          if ! cargo fmt --check -- --color=always 2>&1 | tee fmt-output.txt; then
            # å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†é”™è¯¯ä¿¡æ¯å†™å…¥ Summary
            echo "### âŒ Formatting Check Failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat fmt-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "**Tip**: Run \`cargo fmt\` to automatically fix formatting issues" >> $GITHUB_STEP_SUMMARY
            # åˆ›å»ºæ ‡è®°æ–‡ä»¶ï¼Œç”¨äºåç»­æ­¥éª¤åˆ¤æ–­æ˜¯å¦æœ‰æ ¼å¼é”™è¯¯
            touch .fmt-failed
            exit 1
          else
            # æ£€æŸ¥é€šè¿‡ï¼Œè®°å½•æˆåŠŸä¿¡æ¯
            echo "### âœ… Formatting Check Passed" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤ 5: æ£€æŸ¥ Rust ä»£ç ç¼–è¯‘
      # ä½¿ç”¨ cargo check æ£€æŸ¥ä»£ç æ˜¯å¦èƒ½æˆåŠŸç¼–è¯‘ï¼Œä½†ä¸ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶
      # æ¯” cargo build æ›´å¿«ï¼Œå› ä¸ºä¸éœ€è¦ç”Ÿæˆæœ€ç»ˆäº§ç‰©
      - name: Check Rust compilation
        id: compile-check  # è®¾ç½®æ­¥éª¤ IDï¼Œç”¨äºåç»­å¼•ç”¨
        working-directory: src-tauri
        continue-on-error: true  # å³ä½¿ç¼–è¯‘å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œåç»­æ£€æŸ¥
        run: |
          # å°†ç¼–è¯‘æ£€æŸ¥æ ‡é¢˜å†™å…¥ Summary
          echo "## ğŸ”¨ Compilation Check" >> $GITHUB_STEP_SUMMARY
          # è¿è¡Œ cargo check æ£€æŸ¥ç¼–è¯‘
          # --all-targets æ£€æŸ¥æ‰€æœ‰ç›®æ ‡ï¼ˆåº“ã€äºŒè¿›åˆ¶æ–‡ä»¶ã€æµ‹è¯•ã€ç¤ºä¾‹ç­‰ï¼‰
          # --message-format=short ä½¿ç”¨ç®€çŸ­æ ¼å¼è¾“å‡ºï¼Œå‡å°‘å†—ä½™ä¿¡æ¯
          if ! cargo check --all-targets --message-format=short 2>&1 | tee compile-output.txt; then
            # ç¼–è¯‘å¤±è´¥ï¼Œå°†é”™è¯¯ä¿¡æ¯å†™å…¥ Summary
            echo "### âŒ Compilation Failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat compile-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "**Tip**: Please check and fix the compilation errors above" >> $GITHUB_STEP_SUMMARY
            # åˆ›å»ºæ ‡è®°æ–‡ä»¶
            touch .compile-failed
            exit 1
          else
            # ç¼–è¯‘æˆåŠŸ
            echo "### âœ… Compilation Check Passed" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤ 6: è¿è¡Œ Clippy ä»£ç æ£€æŸ¥
      # Clippy æ˜¯ Rust çš„å®˜æ–¹ linterï¼Œç”¨äºæ£€æŸ¥ä»£ç è´¨é‡å’Œå¸¸è§é”™è¯¯
      # å¯ä»¥å‘ç°æ½œåœ¨ bugã€æ€§èƒ½é—®é¢˜ã€ä»£ç å¼‚å‘³ç­‰
      - name: Run Clippy linter
        id: clippy-check  # è®¾ç½®æ­¥éª¤ ID
        working-directory: src-tauri
        continue-on-error: true  # å³ä½¿æœ‰è­¦å‘Šä¹Ÿç»§ç»­æ‰§è¡Œ
        run: |
          # å°† Clippy æ£€æŸ¥æ ‡é¢˜å†™å…¥ Summary
          echo "## ğŸ§¹ Clippy Code Quality Check" >> $GITHUB_STEP_SUMMARY
          # è¿è¡Œ cargo clippy è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥
          # --all-targets æ£€æŸ¥æ‰€æœ‰ç›®æ ‡
          # --message-format=short ä½¿ç”¨ç®€çŸ­æ ¼å¼
          # -- -D warnings è¡¨ç¤ºå°†æ‰€æœ‰è­¦å‘Šè§†ä¸ºé”™è¯¯ï¼ˆdeny warningsï¼‰
          # è¿™æ ·å¯ä»¥ç¡®ä¿ä»£ç æ²¡æœ‰ä»»ä½•è­¦å‘Šæ‰èƒ½é€šè¿‡æ£€æŸ¥
          if ! cargo clippy --all-targets --message-format=short -- -D warnings 2>&1 | tee clippy-output.txt; then
            # Clippy æ£€æŸ¥å¤±è´¥ï¼Œè®°å½•é”™è¯¯ä¿¡æ¯
            echo "### âŒ Clippy Check Failed" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat clippy-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "**Tip**: Please fix the warnings and errors above. Run \`cargo clippy --fix\` to automatically fix some issues" >> $GITHUB_STEP_SUMMARY
            # åˆ›å»ºæ ‡è®°æ–‡ä»¶
            touch .clippy-failed
            exit 1
          else
            # Clippy æ£€æŸ¥é€šè¿‡
            echo "### âœ… Clippy Check Passed" >> $GITHUB_STEP_SUMMARY
          fi

      # æ­¥éª¤ 7: åœ¨ PR ä¸­è¯„è®ºé”™è¯¯ä¿¡æ¯
      # å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œè‡ªåŠ¨åœ¨ PR ä¸­æ·»åŠ è¯„è®ºï¼Œè¯¦ç»†è¯´æ˜é—®é¢˜
      # è¿™æ ·è´¡çŒ®è€…å¯ä»¥ç›´æ¥åœ¨ PR é¡µé¢çœ‹åˆ°éœ€è¦ä¿®å¤çš„é—®é¢˜ï¼Œæ— éœ€æŸ¥çœ‹ Actions æ—¥å¿—
      - name: Comment PR with errors
        # if: always() è¡¨ç¤ºæ— è®ºå‰é¢çš„æ­¥éª¤æˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šæ‰§è¡Œ
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ­¥éª¤å¤±è´¥ï¼ˆæ ¼å¼ã€ç¼–è¯‘æˆ– Clippyï¼‰
        if: always() && (steps.fmt-check.outcome == 'failure' || steps.compile-check.outcome == 'failure' || steps.clippy-check.outcome == 'failure')
        uses: actions/github-script@v7  # ä½¿ç”¨ GitHub Script action æ¥è°ƒç”¨ GitHub API
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}  # ä½¿ç”¨ GitHub è‡ªåŠ¨ç”Ÿæˆçš„ token è¿›è¡Œ API è°ƒç”¨
          script: |
            const fs = require('fs');
            const path = require('path');
            // æ„å»ºè¯„è®ºå†…å®¹ï¼Œä½¿ç”¨ Markdown æ ¼å¼
            let comment = '## âŒ Rust Code Check Failed\n\n';
            comment += 'Please fix the following issues and resubmit:\n\n';
            let hasErrors = false;
            
            // è¯»å–æ ¼å¼æ£€æŸ¥çš„é”™è¯¯è¾“å‡ºæ–‡ä»¶
            // å¦‚æœæ–‡ä»¶å­˜åœ¨ä¸”æœ‰å†…å®¹ï¼Œå°†å…¶æ·»åŠ åˆ°è¯„è®ºä¸­
            const fmtPath = path.join('src-tauri', 'fmt-output.txt');
            if (fs.existsSync(fmtPath)) {
              const fmtOutput = fs.readFileSync(fmtPath, 'utf8');
              if (fmtOutput.trim()) {
                hasErrors = true;
                comment += '### ğŸ” Code Formatting Issues\n';
                comment += '```\n' + fmtOutput.trim() + '\n```\n';
                comment += '**Fix**: Run `cargo fmt` to automatically fix formatting\n\n';
              }
            }
            
            // è¯»å–ç¼–è¯‘é”™è¯¯è¾“å‡ºæ–‡ä»¶
            // è¿‡æ»¤è¾“å‡ºï¼Œåªä¿ç•™åŒ…å«é”™è¯¯æˆ–è­¦å‘Šçš„è¡Œï¼Œå‡å°‘å†—ä½™ä¿¡æ¯
            const compilePath = path.join('src-tauri', 'compile-output.txt');
            if (fs.existsSync(compilePath)) {
              const compileOutput = fs.readFileSync(compilePath, 'utf8');
              // è¿‡æ»¤æ‰ä¸ç›¸å…³çš„è¾“å‡ºï¼Œåªä¿ç•™é”™è¯¯ä¿¡æ¯
              const errorLines = compileOutput.split('\n').filter(line => 
                line.includes('error') || line.includes('Error') || line.includes('warning')
              );
              if (errorLines.length > 0) {
                hasErrors = true;
                comment += '### ğŸ”¨ Compilation Errors\n';
                comment += '```\n' + errorLines.join('\n') + '\n```\n';
                comment += '**Fix**: Please fix the code according to the error messages\n\n';
              }
            }
            
            // è¯»å– Clippy é”™è¯¯è¾“å‡ºæ–‡ä»¶
            // åŒæ ·è¿‡æ»¤è¾“å‡ºï¼Œåªä¿ç•™è­¦å‘Šå’Œé”™è¯¯ä¿¡æ¯
            const clippyPath = path.join('src-tauri', 'clippy-output.txt');
            if (fs.existsSync(clippyPath)) {
              const clippyOutput = fs.readFileSync(clippyPath, 'utf8');
              // è¿‡æ»¤å‡ºè­¦å‘Šå’Œé”™è¯¯
              const errorLines = clippyOutput.split('\n').filter(line => 
                line.includes('error') || line.includes('warning') || line.includes('Error') || line.includes('Warning')
              );
              if (errorLines.length > 0) {
                hasErrors = true;
                comment += '### ğŸ§¹ Clippy Code Quality Issues\n';
                comment += '```\n' + errorLines.join('\n') + '\n```\n';
                comment += '**Fix**: Run `cargo clippy --fix` to automatically fix some issues\n\n';
              }
            }
            
            // å¦‚æœæœ‰ä»»ä½•é”™è¯¯ï¼Œæ·»åŠ æ€»ç»“å’Œå¿«é€Ÿä¿®å¤å‘½ä»¤
            if (hasErrors) {
              comment += '---\n';
              comment += 'ğŸ’¡ **Tip**: After fixing, resubmit your code and the checks will automatically run again.\n';
              comment += '\nğŸ“‹ **Quick Fix Commands**:\n';
              comment += '```bash\n';
              comment += 'cd src-tauri\n';
              // æ ¹æ®å“ªäº›æ£€æŸ¥å¤±è´¥ï¼Œæ·»åŠ ç›¸åº”çš„ä¿®å¤å‘½ä»¤
              if (fs.existsSync(path.join('src-tauri', '.fmt-failed'))) {
                comment += 'cargo fmt  # Fix formatting issues\n';
              }
              if (fs.existsSync(path.join('src-tauri', '.clippy-failed'))) {
                comment += 'cargo clippy --fix  # Fix Clippy issues\n';
              }
              comment += '```\n';
              
              // ä½¿ç”¨ GitHub API åœ¨ PR ä¸­æ·»åŠ è¯„è®º
              // context.issue.number æ˜¯ PR çš„ç¼–å·
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      # æ­¥éª¤ 8: å¦‚æœä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œä½¿æ•´ä¸ª workflow å¤±è´¥
      # è¿™æ˜¯æœ€åä¸€æ­¥ï¼Œç”¨äºç¡®ä¿å¦‚æœæœ‰ä»»ä½•æ£€æŸ¥å¤±è´¥ï¼Œæ•´ä¸ª workflow ä¼šæ ‡è®°ä¸ºå¤±è´¥
      # è¿™æ ·å¯ä»¥é˜»æ­¢æœ‰é—®é¢˜çš„ä»£ç è¢«åˆå¹¶åˆ°ä¸»åˆ†æ”¯
      - name: Fail if any check failed
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•æ­¥éª¤å¤±è´¥
        # å¦‚æœæ ¼å¼æ£€æŸ¥ã€ç¼–è¯‘æ£€æŸ¥æˆ– Clippy æ£€æŸ¥ä¸­ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™æ‰§è¡Œæ­¤æ­¥éª¤
        if: steps.fmt-check.outcome == 'failure' || steps.compile-check.outcome == 'failure' || steps.clippy-check.outcome == 'failure'
        run: |
          # è¾“å‡ºå¤±è´¥ä¿¡æ¯ï¼Œæç¤ºæŸ¥çœ‹è¯¦ç»†é”™è¯¯å’Œ PR è¯„è®º
          echo "âŒ Rust code check failed. Please check the detailed error messages above and the PR comment"
          exit 1  # é€€å‡ºç  1 è¡¨ç¤ºå¤±è´¥ï¼Œä¼šä½¿æ•´ä¸ª workflow æ ‡è®°ä¸ºå¤±è´¥
